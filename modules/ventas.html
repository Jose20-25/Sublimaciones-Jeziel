<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - Sublimaciones Jeziel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS para generar archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="../js/firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f7fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sidebar-logo-icon img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        .sidebar-logo-text {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 0 20px 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0aec0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #667eea;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        /* Layout */
        .main-layout {
            margin-left: 280px;
            min-height: 100vh;
            background: #f7fafc;
        }

        /* Container */
        .container {
            padding: 30px;
            max-width: none;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title i {
            color: #667eea;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-icon.sales { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-icon.revenue { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }
        .stat-icon.pending { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; }
        .stat-icon.completed { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: white; }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-weight: 500;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .form-input, .form-select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .table th:hover {
            background: #edf2f7;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .table tr:hover {
            background: #f8fafc;
        }

        .sale-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sale-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .sale-details h4 {
            margin: 0;
            color: #2d3748;
            font-weight: 600;
        }

        .sale-details p {
            margin: 2px 0 0;
            color: #718096;
            font-size: 13px;
        }

        .customer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 13px;
            color: #4a5568;
        }

        .customer-item i {
            width: 16px;
            color: #718096;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.pending {
            background: #feebc8;
            color: #7b341e;
        }

        .status.processing {
            background: #bee3f8;
            color: #2a4365;
        }

        .status.completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.cancelled {
            background: #fed7d7;
            color: #742a2a;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-edit {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-edit:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #fed7d7;
            color: #e53e3e;
        }

        .btn-delete:hover {
            background: #feb2b2;
            transform: translateY(-1px);
        }

        .btn-view {
            background: #e6fffa;
            color: #234e52;
        }

        .btn-view:hover {
            background: #b2f5ea;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #edf2f7;
            color: #4a5568;
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .form-textarea {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        /* Products Section */
        .products-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f7fafc;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-product-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .add-product-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .products-table th,
        .products-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .products-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .product-row input,
        .product-row select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }

        .remove-product-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .remove-product-btn:hover {
            background: #c53030;
        }

        .total-section {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: right;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .total-final {
            font-size: 18px;
            color: #2d3748;
            border-top: 2px solid #e2e8f0;
            padding-top: 10px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-layout {
                margin-left: 0;
            }
            
            .container {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <img src="../logo/logo.jpg" alt="Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-print\'></i>';">
                </div>
                <div class="sidebar-logo-text">Sublimaciones Jeziel</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="../index.html" class="nav-item">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            
            <div class="nav-section">
                <div class="nav-section-title">Gestión Principal</div>
                <a href="#" class="nav-item active" onclick="navigateToModule('ventas')">
                    <i class="fas fa-shopping-cart"></i>
                    Ventas
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('compras')">
                    <i class="fas fa-shopping-bag"></i>
                    Compras
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('inventario')">
                    <i class="fas fa-boxes"></i>
                    Inventario
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('produccion')">
                    <i class="fas fa-industry"></i>
                    Producción
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('clientes')">
                    <i class="fas fa-users"></i>
                    Clientes
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('proveedores')">
                    <i class="fas fa-truck"></i>
                    Proveedores
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Facturación</div>
                <a href="#" class="nav-item" onclick="navigateToModule('facturas')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Facturas
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('contabilidad')">
                    <i class="fas fa-calculator"></i>
                    Contabilidad
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('finanzas')">
                    <i class="fas fa-chart-line"></i>
                    Finanzas
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Administración</div>
                <a href="#" class="nav-item" onclick="navigateToModule('reportes')">
                    <i class="fas fa-chart-bar"></i>
                    Reportes
                </a>
                <a href="#" class="nav-item" onclick="navigateToModule('configuracion')">
                    <i class="fas fa-cog"></i>
                    Configuración
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Soporte</div>
                <a href="#" class="nav-item" onclick="navigateToModule('soporte')">
                    <i class="fas fa-life-ring"></i>
                    Ayuda
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-layout">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">
                    <i class="fas fa-shopping-cart"></i>
                    Gestión de Ventas
                </h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="debugInventoryData()" style="margin-right: 10px;">
                        <i class="fas fa-bug"></i>
                        Debug Inventario
                    </button>
                    <button class="btn btn-secondary" onclick="testStockUpdate()" style="margin-right: 10px;">
                        <i class="fas fa-vial"></i>
                        Test Stock
                    </button>
                    <button class="btn btn-secondary" onclick="fixProductPrices()" style="margin-right: 10px;">
                        <i class="fas fa-dollar-sign"></i>
                        Fijar Precios
                    </button>
                    <button class="btn btn-secondary" onclick="exportSales()">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                    <button class="btn btn-success" onclick="openAddSaleModal()">
                        <i class="fas fa-plus"></i>
                        Nueva Venta
                    </button>
                </div>
            </header>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon sales">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-value" id="totalSales">0</div>
                    <div class="stat-label">Total Ventas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon revenue">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-value" id="totalRevenue">S/ 0.00</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="pendingSales">0</div>
                    <div class="stat-label">Ventas Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="completedSales">0</div>
                    <div class="stat-label">Ventas Completadas</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Buscar</label>
                    <input type="text" class="form-input" id="searchInput" placeholder="Buscar por factura o cliente...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Estado</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendiente</option>
                        <option value="processing">En Proceso</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fecha desde</label>
                    <input type="date" class="form-input" id="dateFromFilter">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fecha hasta</label>
                    <input type="date" class="form-input" id="dateToFilter">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Ordenar por</label>
                    <select class="form-select" id="sortFilter">
                        <option value="date">Fecha</option>
                        <option value="invoice">Factura</option>
                        <option value="customer">Cliente</option>
                        <option value="total">Total</option>
                        <option value="status">Estado</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Factura</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar venta -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Venta</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Número de Factura</label>
                            <input type="text" class="form-input" id="saleInvoice" readonly style="background: #f7fafc; color: #718096;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <select class="form-select" id="saleCustomer" required>
                                <option value="">Seleccionar cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" class="form-input" id="saleDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="saleStatus">
                                <option value="pending">Pendiente</option>
                                <option value="processing">En Proceso</option>
                                <option value="completed">Completada</option>
                                <option value="cancelled">Cancelada</option>
                            </select>
                        </div>
                    </div>

                    <!-- Productos Section -->
                    <div class="products-section">
                        <div class="products-header">
                            <h4>Productos</h4>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <small style="color: #718096; font-style: italic;">
                                    <i class="fas fa-info-circle"></i>
                                    Los precios ya incluyen IVA (13%)
                                </small>
                                <button type="button" class="add-product-btn" onclick="addProductRow()">
                                    <i class="fas fa-plus"></i> Agregar Producto
                                </button>
                            </div>
                        </div>
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit. (inc. IVA)</th>
                                    <th>Subtotal (inc. IVA)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Las filas de productos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                        
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal (sin IVA):</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>IVA (13%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="total-row total-final">
                                <span>Total (inc. IVA):</span>
                                <span id="totalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">Notas</label>
                        <textarea class="form-textarea" id="saleNotes" placeholder="Notas adicionales sobre la venta..."></textarea>
                    </div>

                    <!-- Información sobre manejo de stock -->
                    <div style="background: #f0f8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #2c5282; font-size: 14px;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Manejo Automático de Inventario:</strong>
                        </div>
                        <ul style="margin: 8px 0 0 24px; color: #2c5282; font-size: 13px;">
                            <li>El stock se descuenta automáticamente cuando la venta está "Completada"</li>
                            <li>Si cambias el estado de una venta, el stock se ajusta automáticamente</li>
                            <li>Al eliminar una venta completada, el stock se restaura</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-success" form="saleForm" id="submitBtn">Guardar Venta</button>
            </div>
        </div>
    </div>

    <script>
        // Función de navegación
        function navigateToModule(module) {
            const routes = {
                'ventas': 'ventas.html',
                'compras': 'compras.html',
                'inventario': 'inventario.html',
                'produccion': 'produccion.html',
                'clientes': 'clientes.html',
                'proveedores': 'proveedores.html',
                'facturas': 'facturas.html',
                'contabilidad': 'contabilidad.html',
                'finanzas': 'finanzas.html',
                'reportes': 'reportes.html',
                'configuracion': 'configuracion.html',
                'soporte': 'soporte.html'
            };
            
            if (routes[module]) {
                window.location.href = routes[module];
            }
        }

        // Funciones para persistencia de datos
        async function saveDataToLocalStorage() {
            try {
                // Guardar usando las funciones compartidas de Firebase
                if (window.firebaseUtils) {
                    await window.firebaseUtils.saveData('salesData', { data: salesData });
                    await window.firebaseUtils.saveData('invoiceCounter', { counter: invoiceCounter });
                } else {
                    // Respaldo con localStorage tradicional
                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    localStorage.setItem('invoiceCounter', invoiceCounter.toString());
                }
                
                console.log('💾 Datos de ventas guardados');
                
                // Notificar al dashboard sobre la actualización
                notifyDashboardUpdate();
            } catch (error) {
                console.error('❌ Error al guardar datos de ventas:', error);
                // Respaldo de emergencia
                localStorage.setItem('salesData', JSON.stringify(salesData));
                localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            }
        }

        // Función para cargar datos al inicializar
        async function loadDataFromLocalStorage() {
            try {
                if (window.firebaseUtils) {
                    // Cargar desde Firebase primero
                    const salesResponse = await window.firebaseUtils.loadData('salesData');
                    if (salesResponse && salesResponse.length > 0) {
                        // Si es un documento con estructura { data: [...] }
                        const firstItem = salesResponse[0];
                        if (firstItem.data && Array.isArray(firstItem.data)) {
                            salesData = firstItem.data;
                        } else {
                            salesData = salesResponse;
                        }
                    }
                    
                    const counterResponse = await window.firebaseUtils.loadData('invoiceCounter');
                    if (counterResponse && counterResponse.length > 0) {
                        invoiceCounter = counterResponse[0].counter || 1001;
                    }
                } else {
                    // Respaldo con localStorage
                    const savedSalesData = localStorage.getItem('salesData');
                    const savedInvoiceCounter = localStorage.getItem('invoiceCounter');
                    
                    if (savedSalesData) {
                        salesData = JSON.parse(savedSalesData);
                    }
                    
                    if (savedInvoiceCounter) {
                        invoiceCounter = parseInt(savedInvoiceCounter);
                    }
                }
                
                console.log('📡 Datos de ventas cargados:', salesData.length, 'registros');
                return salesData.length > 0;
                
            } catch (error) {
                console.error('❌ Error al cargar datos de ventas:', error);
                return false;
            }
        }

        // Función para notificar actualizaciones al dashboard
        function notifyDashboardUpdate() {
            try {
                // Intentar acceder a la función global del dashboard
                if (window.parent && window.parent.notifyDashboardUpdate) {
                    window.parent.notifyDashboardUpdate();
                } else if (window.opener && window.opener.notifyDashboardUpdate) {
                    window.opener.notifyDashboardUpdate();
                } else if (window.top && window.top.notifyDashboardUpdate) {
                    window.top.notifyDashboardUpdate();
                }
                
                // También disparar evento en esta ventana por si acaso
                window.dispatchEvent(new CustomEvent('dashboardUpdate'));
                
                // Intentar actualizar a través de localStorage trigger
                localStorage.setItem('dashboardLastUpdate', Date.now().toString());
            } catch (error) {
                console.log('No se pudo notificar al dashboard:', error);
            }
        }

        // Cargar clientes desde localStorage
        function loadCustomersFromLocalStorage() {
            try {
                const savedCustomersData = localStorage.getItem('customersData');
                if (savedCustomersData) {
                    return JSON.parse(savedCustomersData);
                }
            } catch (error) {
                console.error('Error al cargar datos de clientes:', error);
            }
            return [];
        }

        // Cargar productos desde localStorage
        function loadProductsFromLocalStorage() {
            try {
                const savedInventoryData = localStorage.getItem('inventoryData');
                if (savedInventoryData) {
                    const products = JSON.parse(savedInventoryData);
                    // Asegurar que todos los productos tengan un precio de venta válido
                    return products.map(product => {
                        let finalPrice = 0;
                        
                        // Buscar precio en diferentes campos posibles
                        if (product.sellingPrice && product.sellingPrice > 0) {
                            finalPrice = product.sellingPrice;
                        } else if (product.price && product.price > 0) {
                            finalPrice = product.price;
                        } else if (product.purchasePrice && product.purchasePrice > 0) {
                            // Si solo hay precio de compra, agregar margen del 50%
                            finalPrice = product.purchasePrice * 1.5;
                        } else {
                            // Precio por defecto según el tipo de producto
                            const defaultPrices = {
                                'camiseta': 15.00,
                                'taza': 8.50,
                                'llavero': 2.00,
                                'mouse pad': 6.00,
                                'gorra': 12.00,
                                'placa': 25.00
                            };
                            
                            const productName = (product.name || '').toLowerCase();
                            for (const [type, price] of Object.entries(defaultPrices)) {
                                if (productName.includes(type)) {
                                    finalPrice = price;
                                    break;
                                }
                            }
                            
                            // Si no coincide con ningún tipo, precio genérico
                            if (finalPrice === 0) {
                                finalPrice = 10.00;
                            }
                        }
                        
                        return {
                            ...product,
                            sellingPrice: finalPrice,
                            price: finalPrice // Asegurar compatibilidad
                        };
                    });
                }
            } catch (error) {
                console.error('Error al cargar datos de inventario:', error);
            }
            return [];
        }

        // Función para limpiar datos (solo para desarrollo/testing)
        function clearAllData() {
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos de ventas? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('salesData');
                localStorage.removeItem('invoiceCounter');
                salesData = [...defaultSalesData];
                invoiceCounter = 1001;
                saveDataToLocalStorage();
                renderTable();
                updateStats();
                alert('Datos reiniciados a valores por defecto.');
            }
        }

        // Datos de ejemplo para ventas (solo se usan si no hay datos guardados)
        const defaultSalesData = [
            {
                id: 1,
                invoice: "FAC-1001",
                customerId: 1,
                customerName: "María García López",
                date: "2025-01-15",
                products: [
                    { name: "Taza Sublimada", quantity: 5, price: 35.00, subtotal: 175.00 },
                    { name: "Camiseta Personalizada", quantity: 2, price: 58.00, subtotal: 116.00 }
                ],
                subtotal: 291.00,
                tax: 52.38,
                total: 343.38,
                status: "completed",
                notes: "Entrega urgente - Cliente satisfecho"
            },
            {
                id: 2,
                invoice: "FAC-1002",
                customerId: 2,
                customerName: "Carlos Rodríguez",
                date: "2025-01-18",
                products: [
                    { name: "Llavero Acrílico", quantity: 50, price: 16.00, subtotal: 800.00 }
                ],
                subtotal: 800.00,
                tax: 144.00,
                total: 944.00,
                status: "processing",
                notes: "Evento corporativo - Entrega pendiente"
            },
            {
                id: 3,
                invoice: "FAC-1003",
                customerId: 3,
                customerName: "Ana Fernández",
                date: "2025-01-20",
                products: [
                    { name: "Mouse Pad Personalizado", quantity: 10, price: 25.00, subtotal: 250.00 },
                    { name: "Taza Sublimada", quantity: 3, price: 35.00, subtotal: 105.00 }
                ],
                subtotal: 355.00,
                tax: 63.90,
                total: 418.90,
                status: "completed",
                notes: "Cliente frecuente - Descuento aplicado"
            },
            {
                id: 4,
                invoice: "FAC-1004",
                customerId: 4,
                customerName: "José Mendoza",
                date: "2025-01-22",
                products: [
                    { name: "Gorra Bordada", quantity: 1, price: 12.00, subtotal: 12.00 }
                ],
                subtotal: 12.00,
                tax: 1.56,
                total: 13.56,
                status: "pending",
                notes: "Muestra para aprobación"
            },
            {
                id: 5,
                invoice: "FAC-1005",
                customerId: 5,
                customerName: "Lucía Vargas",
                date: "2025-01-25",
                products: [
                    { name: "Placa Conmemorativa", quantity: 5, price: 25.00, subtotal: 125.00 },
                    { name: "Camiseta Personalizada", quantity: 8, price: 15.00, subtotal: 120.00 }
                ],
                subtotal: 245.00,
                tax: 31.85,
                total: 276.85,
                status: "processing",
                notes: "Souvenirs para turistas - Entrega semanal"
            }
        ];

        // Variables globales
        let salesData = [];
        let invoiceCounter = 1006; // Comienza después de los datos de ejemplo
        let currentEditId = null;
        let customersData = [];
        let inventoryData = [];

        // Cargar datos al inicializar
        customersData = loadCustomersFromLocalStorage();
        inventoryData = loadProductsFromLocalStorage();

        // Debug: Verificar que se carguen los datos correctamente
        console.log('Datos de inventario cargados:', inventoryData);
        console.log('Cantidad de productos en inventario:', inventoryData.length);

        if (!loadDataFromLocalStorage()) {
            salesData = [...defaultSalesData];
            saveDataToLocalStorage();
        }

        // Función para generar número de factura automático
        function generateInvoiceNumber() {
            return `FAC-${invoiceCounter.toString().padStart(4, '0')}`;
        }

        // Función para cargar clientes en el select
        function loadCustomersSelect() {
            const select = document.getElementById('saleCustomer');
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            customersData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.code} - ${customer.name}`;
                select.appendChild(option);
            });
        }

        // Función para agregar fila de producto
        function addProductRow() {
            const tbody = document.getElementById('productsTableBody');
            const row = document.createElement('tr');
            row.className = 'product-row';
            
            // Recargar datos de inventario para asegurar información actualizada
            inventoryData = loadProductsFromLocalStorage();
            
            row.innerHTML = `
                <td>
                    <select class="product-select" onchange="updateProductPrice(this)" required>
                        <option value="">Seleccionar producto</option>
                        ${inventoryData.map(product => {
                            const sellingPrice = product.sellingPrice || product.price || 0;
                            const stock = parseInt(product.quantity) || parseInt(product.stock) || 0;
                            const stockStatus = stock > 10 ? '✅' : stock > 0 ? '⚠️' : '❌';
                            return `<option value="${product.id}" data-price="${sellingPrice}" data-stock="${stock}">${product.code} - ${product.name} | $${sellingPrice.toFixed(2)} | ${stockStatus} Stock: ${stock}</option>`;
                        }).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="quantity-input" min="1" value="1" onchange="calculateRowSubtotal(this)" required>
                </td>
                <td>
                    <input type="number" class="price-input" min="0" step="0.01" value="0.00" readonly style="background: #f7fafc; color: #4a5568; cursor: not-allowed;">
                </td>
                <td>
                    <span class="subtotal-display">$0.00</span>
                </td>
                <td>
                    <button type="button" class="remove-product-btn" onclick="removeProductRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        // Función para actualizar precio del producto seleccionado
        function updateProductPrice(select) {
            const row = select.closest('tr');
            const priceInput = row.querySelector('.price-input');
            const quantityInput = row.querySelector('.quantity-input');
            
            console.log('updateProductPrice llamado, valor seleccionado:', select.value);
            
            if (select.value && select.value !== '') {
                const productId = parseInt(select.value);
                console.log('Buscando producto con ID:', productId);
                console.log('Inventario disponible:', inventoryData);
                
                const product = inventoryData.find(p => parseInt(p.id) === productId);
                console.log('Producto encontrado:', product);
                
                if (product) {
                    // Usar precio de venta del inventario (prioridad: sellingPrice > price > 0)
                    const sellingPrice = product.sellingPrice || product.price || 0;
                    console.log('Precio a establecer:', sellingPrice);
                    
                    priceInput.value = parseFloat(sellingPrice).toFixed(2);
                    
                    // Mostrar cantidad disponible en inventario
                    const availableQuantity = parseInt(product.quantity) || parseInt(product.stock) || 0;
                    console.log('Stock disponible:', availableQuantity);
                    
                    quantityInput.setAttribute('max', availableQuantity);
                    quantityInput.setAttribute('title', `Disponible en inventario: ${availableQuantity} unidades`);
                    
                    // Agregar indicador visual de stock
                    updateStockIndicator(row, availableQuantity);
                    
                    // Recalcular subtotal
                    calculateRowSubtotal(quantityInput);
                } else {
                    console.log('Producto no encontrado en inventario');
                    priceInput.value = '0.00';
                    quantityInput.removeAttribute('max');
                    quantityInput.removeAttribute('title');
                    removeStockIndicator(row);
                    calculateRowSubtotal(quantityInput);
                }
            } else {
                console.log('No hay producto seleccionado, limpiando campos');
                // Si no hay producto seleccionado, limpiar campos
                priceInput.value = '0.00';
                quantityInput.removeAttribute('max');
                quantityInput.removeAttribute('title');
                removeStockIndicator(row);
                calculateRowSubtotal(quantityInput);
            }
        }

        // Función para agregar indicador de stock
        function updateStockIndicator(row, availableQuantity) {
            // Remover indicador existente si lo hay
            removeStockIndicator(row);
            
            const quantityCell = row.querySelector('.quantity-input').parentElement;
            const stockIndicator = document.createElement('div');
            stockIndicator.className = 'stock-indicator';
            stockIndicator.style.cssText = `
                font-size: 11px;
                margin-top: 2px;
                font-weight: 600;
                color: ${availableQuantity > 10 ? '#22543d' : availableQuantity > 0 ? '#c05621' : '#e53e3e'};
            `;
            
            if (availableQuantity > 0) {
                stockIndicator.innerHTML = `<i class="fas fa-box"></i> Stock: ${availableQuantity}`;
            } else {
                stockIndicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Sin stock`;
            }
            
            quantityCell.appendChild(stockIndicator);
        }

        // Función para remover indicador de stock
        function removeStockIndicator(row) {
            const existingIndicator = row.querySelector('.stock-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        }

        // Función para calcular subtotal de fila
        function calculateRowSubtotal(input) {
            const row = input.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const priceInput = row.querySelector('.price-input');
            const subtotalDisplay = row.querySelector('.subtotal-display');
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const maxQuantity = parseInt(quantityInput.getAttribute('max')) || 0;
            
            // Validar que no se exceda el stock disponible
            if (maxQuantity > 0 && quantity > maxQuantity) {
                quantityInput.style.border = '2px solid #e53e3e';
                quantityInput.style.background = '#fed7d7';
                alert(`La cantidad solicitada (${quantity}) excede el stock disponible (${maxQuantity})`);
                quantityInput.value = maxQuantity;
                return;
            } else {
                quantityInput.style.border = '2px solid #e2e8f0';
                quantityInput.style.background = 'white';
            }
            
            const subtotal = (parseFloat(quantityInput.value) || 0) * price;
            subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
            calculateTotals();
        }

        // Función para eliminar fila de producto
        function removeProductRow(button) {
            button.closest('tr').remove();
            calculateTotals();
        }

        // Función de debug para verificar datos de inventario
        function debugInventoryData() {
            console.log('=== DEBUG INVENTARIO ===');
            
            // Recargar datos frescos
            const freshInventoryData = loadProductsFromLocalStorage();
            
            console.log('Datos del localStorage (inventoryData):', localStorage.getItem('inventoryData'));
            console.log('Datos parseados:', freshInventoryData);
            console.log('Cantidad de productos:', freshInventoryData.length);
            
            if (freshInventoryData.length > 0) {
                console.log('Primer producto como ejemplo:', freshInventoryData[0]);
                
                let debugMessage = 'PRODUCTOS EN INVENTARIO:\n\n';
                let hasZeroPrices = false;
                
                freshInventoryData.forEach((product, index) => {
                    const info = {
                        id: product.id,
                        code: product.code,
                        name: product.name,
                        quantity: product.quantity,
                        stock: product.stock,
                        price: product.price,
                        sellingPrice: product.sellingPrice,
                        purchasePrice: product.purchasePrice
                    };
                    console.log(`Producto ${index + 1}:`, info);
                    
                    const finalPrice = product.sellingPrice || product.price || 0;
                    const finalStock = parseInt(product.quantity) || parseInt(product.stock) || 0;
                    
                    if (finalPrice === 0) hasZeroPrices = true;
                    
                    debugMessage += `${index + 1}. ${product.code} - ${product.name}\n`;
                    debugMessage += `   Precio: $${finalPrice.toFixed(2)} ${finalPrice === 0 ? '⚠️ SIN PRECIO' : '✅'}\n`;
                    debugMessage += `   Stock: ${finalStock} unidades\n\n`;
                });
                
                if (hasZeroPrices) {
                    debugMessage += '\n⚠️ ALGUNOS PRODUCTOS NO TIENEN PRECIO\n';
                    debugMessage += 'Se han asignado precios automáticos.\n';
                    debugMessage += '¿Quieres actualizar el inventario con estos precios?';
                    
                    if (confirm(debugMessage + '\n\n¿Actualizar inventario con precios automáticos?')) {
                        updateInventoryPrices(freshInventoryData);
                    }
                } else {
                    alert(debugMessage + '\nRevisa la consola (F12) para más detalles');
                }
            } else {
                console.log('No hay productos en el inventario');
                alert('¡ERROR! No hay productos en el inventario.\n\nPor favor, ve al módulo de Inventario y agrega algunos productos primero.');
            }
        }

        // Función para actualizar precios en el inventario
        function updateInventoryPrices(productsWithPrices) {
            try {
                localStorage.setItem('inventoryData', JSON.stringify(productsWithPrices));
                console.log('Precios actualizados en el inventario');
                
                // Recargar datos actualizados
                inventoryData = loadProductsFromLocalStorage();
                
                alert('✅ Precios actualizados correctamente en el inventario!\n\nAhora los productos tendrán precios automáticos cuando los selecciones.');
            } catch (error) {
                console.error('Error al actualizar precios:', error);
                alert('❌ Error al actualizar precios. Revisa la consola para más detalles.');
            }
        }

        // Función para fijar precios automáticamente
        function fixProductPrices() {
            const productsWithPrices = loadProductsFromLocalStorage();
            
            if (productsWithPrices.length === 0) {
                alert('❌ No hay productos en el inventario para actualizar.');
                return;
            }
            
            let updatedCount = 0;
            const updatedProducts = productsWithPrices.map(product => {
                const originalPrice = product.sellingPrice || product.price || 0;
                if (originalPrice === 0) {
                    updatedCount++;
                }
                return product; // Ya se procesó en loadProductsFromLocalStorage
            });
            
            if (updatedCount > 0) {
                if (confirm(`Se encontraron ${updatedCount} productos sin precio.\n\n¿Quieres asignar precios automáticos basados en el tipo de producto?`)) {
                    updateInventoryPrices(updatedProducts);
                }
            } else {
                alert('✅ Todos los productos ya tienen precios asignados.\n\nNo es necesario actualizar nada.');
            }
        }

        // Función de test para verificar actualización de stock
        function testStockUpdate() {
            console.log('=== TEST DE ACTUALIZACIÓN DE STOCK ===');
            
            // Obtener inventario actual
            const currentInventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
            
            if (currentInventory.length === 0) {
                alert('❌ No hay productos en el inventario para hacer la prueba.');
                return;
            }
            
            // Crear productos de prueba basados en el inventario real
            const testProducts = currentInventory.slice(0, 2).map(product => ({
                id: product.id,
                name: product.name,
                quantity: 1,
                price: product.sellingPrice || product.price || 10,
                subtotal: product.sellingPrice || product.price || 10
            }));
            
            console.log('Productos de prueba:', testProducts);
            console.log('Inventario antes del test:', currentInventory);
            
            // Ejecutar test
            const result = updateInventoryStock(testProducts);
            
            console.log('Resultado del test:', result);
            
            let message = 'TEST DE ACTUALIZACIÓN DE STOCK:\n\n';
            if (result.length > 0) {
                result.forEach(update => {
                    message += `✅ ${update.product}:\n`;
                    message += `   Stock anterior: ${update.previous}\n`;
                    message += `   Cantidad vendida: ${update.sold}\n`;
                    message += `   Nuevo stock: ${update.new}\n\n`;
                });
                message += 'Revisa la consola (F12) para más detalles.';
            } else {
                message += '❌ No se actualizó ningún producto.\nRevisa la consola (F12) para más detalles.';
            }
            
            alert(message);
        }

        // Función para actualizar stock del inventario (descontar cantidades vendidas)
        function updateInventoryStock(soldProducts) {
            console.log('=== INICIANDO ACTUALIZACIÓN DE STOCK ===');
            console.log('Productos vendidos:', soldProducts);
            
            try {
                // Cargar inventario actual
                let currentInventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
                console.log('Inventario actual antes de actualización:', currentInventory);
                
                let stockUpdated = false;
                let updateLog = [];
                
                soldProducts.forEach(soldProduct => {
                    console.log(`Procesando producto vendido: ID=${soldProduct.id}, Nombre=${soldProduct.name}, Cantidad=${soldProduct.quantity}`);
                    
                    // Buscar el producto en el inventario por ID primero, luego por nombre
                    const inventoryIndex = currentInventory.findIndex(invProduct => {
                        const matchById = invProduct.id == soldProduct.id;
                        const matchByName = invProduct.name === soldProduct.name;
                        console.log(`Comparando con inventario: ID=${invProduct.id}, Nombre=${invProduct.name}, Match por ID: ${matchById}, Match por nombre: ${matchByName}`);
                        return matchById || matchByName;
                    });
                    
                    console.log(`Índice encontrado en inventario: ${inventoryIndex}`);
                    
                    if (inventoryIndex !== -1) {
                        const inventoryProduct = currentInventory[inventoryIndex];
                        const currentStock = parseInt(inventoryProduct.quantity) || parseInt(inventoryProduct.stock) || 0;
                        const soldQuantity = parseInt(soldProduct.quantity) || 0;
                        const newStock = Math.max(0, currentStock - soldQuantity);
                        
                        console.log(`Stock actual: ${currentStock}, Cantidad vendida: ${soldQuantity}, Nuevo stock: ${newStock}`);
                        
                        // Actualizar stock (usar el campo que existe)
                        if (inventoryProduct.quantity !== undefined) {
                            currentInventory[inventoryIndex].quantity = newStock;
                        } else if (inventoryProduct.stock !== undefined) {
                            currentInventory[inventoryIndex].stock = newStock;
                        }
                        
                        stockUpdated = true;
                        
                        updateLog.push({
                            product: soldProduct.name,
                            id: soldProduct.id,
                            previous: currentStock,
                            sold: soldQuantity,
                            new: newStock
                        });
                        
                        console.log(`✅ Stock actualizado: ${soldProduct.name} - Anterior: ${currentStock}, Vendido: ${soldQuantity}, Nuevo: ${newStock}`);
                    } else {
                        console.warn(`❌ Producto no encontrado en inventario: ID=${soldProduct.id}, Nombre=${soldProduct.name}`);
                    }
                });
                
                if (stockUpdated) {
                    // Guardar inventario actualizado
                    localStorage.setItem('inventoryData', JSON.stringify(currentInventory));
                    console.log('Inventario actualizado en localStorage:', currentInventory);
                    
                    // Recargar datos de inventario en memoria
                    inventoryData = loadProductsFromLocalStorage();
                    
                    console.log('✅ Stock del inventario actualizado automáticamente:', updateLog);
                    return updateLog;
                } else {
                    console.warn('❌ No se actualizó ningún producto en el inventario');
                    return [];
                }
                
            } catch (error) {
                console.error('❌ Error al actualizar stock del inventario:', error);
                return [];
            }
        }

        // Función para restaurar stock del inventario (cuando se cancela o modifica una venta)
        function restoreInventoryStock(productsToRestore) {
            try {
                // Cargar inventario actual
                let currentInventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
                let stockRestored = false;
                let restoreLog = [];
                
                productsToRestore.forEach(product => {
                    // Buscar el producto en el inventario por ID o nombre
                    const inventoryIndex = currentInventory.findIndex(invProduct => 
                        invProduct.id == product.id || 
                        invProduct.name === product.name
                    );
                    
                    if (inventoryIndex !== -1) {
                        const currentStock = parseInt(currentInventory[inventoryIndex].quantity) || 0;
                        const restoreQuantity = parseInt(product.quantity) || 0;
                        const newStock = currentStock + restoreQuantity;
                        
                        // Restaurar stock
                        currentInventory[inventoryIndex].quantity = newStock;
                        stockRestored = true;
                        
                        restoreLog.push({
                            product: product.name,
                            previous: currentStock,
                            restored: restoreQuantity,
                            new: newStock
                        });
                        
                        console.log(`Stock restaurado: ${product.name} - Anterior: ${currentStock}, Restaurado: ${restoreQuantity}, Nuevo: ${newStock}`);
                    }
                });
                
                if (stockRestored) {
                    // Guardar inventario actualizado
                    localStorage.setItem('inventoryData', JSON.stringify(currentInventory));
                    
                    // Recargar datos de inventario en memoria
                    inventoryData = loadProductsFromLocalStorage();
                    
                    console.log('Stock del inventario restaurado:', restoreLog);
                }
                
            } catch (error) {
                console.error('Error al restaurar stock del inventario:', error);
            }
        }

        // Función para calcular totales
        function calculateTotals() {
            const subtotalElements = document.querySelectorAll('.subtotal-display');
            let totalWithIVA = 0; // Total que ya incluye IVA
            
            subtotalElements.forEach(element => {
                const value = parseFloat(element.textContent.replace('$', '')) || 0;
                totalWithIVA += value; // Suma de cantidad × precio (que ya incluye IVA)
            });
            
            // Calcular subtotal sin IVA (precio sin IVA)
            // Si el precio incluye 13% de IVA: precio_sin_iva = precio_con_iva / 1.13
            const subtotalWithoutIVA = totalWithIVA / 1.13;
            const ivaAmount = totalWithIVA - subtotalWithoutIVA;
            
            document.getElementById('subtotalAmount').textContent = `$${subtotalWithoutIVA.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${ivaAmount.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${totalWithIVA.toFixed(2)}`;
        }

        // Función para renderizar la tabla
        function renderTable(data = salesData) {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No hay ventas encontradas</td></tr>';
                return;
            }

            data.forEach(sale => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div class="sale-info">
                            <div class="sale-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="sale-details">
                                <h4>${sale.invoice}</h4>
                                <p>${sale.products.length} producto(s)</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="customer-item">
                            <i class="fas fa-user"></i>
                            <span>${sale.customerName}</span>
                        </div>
                    </td>
                    <td>
                        <strong>${new Date(sale.date).toLocaleDateString('es-ES')}</strong>
                    </td>
                    <td>
                        ${sale.products.slice(0, 2).map(product => 
                            `<div style="font-size: 13px; margin-bottom: 2px;">${product.quantity}x ${product.name}</div>`
                        ).join('')}
                        ${sale.products.length > 2 ? `<div style="font-size: 12px; color: #718096;">+${sale.products.length - 2} más...</div>` : ''}
                    </td>
                    <td>
                        <strong>$${sale.total.toFixed(2)}</strong>
                        <br><small style="color: #718096;">IVA inc.</small>
                    </td>
                    <td>
                        <span class="status ${sale.status}">
                            ${sale.status === 'pending' ? 'Pendiente' : 
                              sale.status === 'processing' ? 'En Proceso' : 
                              sale.status === 'completed' ? 'Completada' : 'Cancelada'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-view" onclick="viewSale(${sale.id})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-small btn-edit" onclick="editSale(${sale.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteSale(${sale.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Función para actualizar estadísticas
        function updateStats() {
            const totalSales = salesData.length;
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.total, 0);
            const pendingSales = salesData.filter(sale => sale.status === 'pending').length;
            const completedSales = salesData.filter(sale => sale.status === 'completed').length;

            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingSales').textContent = pendingSales;
            document.getElementById('completedSales').textContent = completedSales;
        }

        // Función para filtrar la tabla
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;
            
            const filteredData = salesData.filter(sale => {
                const matchesSearch = sale.invoice.toLowerCase().includes(searchTerm) ||
                                    sale.customerName.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || sale.status === statusFilter;
                const matchesDateFrom = !dateFromFilter || sale.date >= dateFromFilter;
                const matchesDateTo = !dateToFilter || sale.date <= dateToFilter;
                
                return matchesSearch && matchesStatus && matchesDateFrom && matchesDateTo;
            });

            renderTable(filteredData);
        }

        // Función para ordenar la tabla
        function sortTable() {
            const sortBy = document.getElementById('sortFilter').value;
            
            const sortedData = [...salesData].sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        return new Date(b.date) - new Date(a.date);
                    case 'invoice':
                        return a.invoice.localeCompare(b.invoice);
                    case 'customer':
                        return a.customerName.localeCompare(b.customerName);
                    case 'total':
                        return b.total - a.total;
                    case 'status':
                        return a.status.localeCompare(b.status);
                    default:
                        return 0;
                }
            });
            renderTable(sortedData);
        }

        // Función para abrir modal de nueva venta
        function openAddSaleModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Nueva Venta';
            document.getElementById('submitBtn').textContent = 'Guardar Venta';
            document.getElementById('saleForm').reset();
            
            // Recargar datos de inventario y clientes para asegurar información actualizada
            customersData = loadCustomersFromLocalStorage();
            inventoryData = loadProductsFromLocalStorage();
            
            console.log('Recargando inventario para nueva venta:', inventoryData.length, 'productos');
            
            // Generar número de factura automático
            document.getElementById('saleInvoice').value = generateInvoiceNumber();
            
            // Establecer fecha actual
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            
            // Limpiar tabla de productos
            document.getElementById('productsTableBody').innerHTML = '';
            addProductRow(); // Agregar una fila inicial
            
            // Cargar clientes
            loadCustomersSelect();
            
            calculateTotals();
            document.getElementById('saleModal').style.display = 'block';
        }

        // Función para editar venta
        function editSale(id) {
            const sale = salesData.find(s => s.id === id);
            if (!sale) return;

            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Editar Venta';
            document.getElementById('submitBtn').textContent = 'Actualizar Venta';

            // Cargar clientes
            loadCustomersSelect();

            // Llenar campos básicos
            document.getElementById('saleInvoice').value = sale.invoice;
            document.getElementById('saleCustomer').value = sale.customerId;
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleStatus').value = sale.status;
            document.getElementById('saleNotes').value = sale.notes || '';

            // Guardar estado original para comparar cambios de stock
            window.originalSaleStatus = sale.status;

            // Cargar productos
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            sale.products.forEach(product => {
                addProductRow();
                const lastRow = tbody.lastElementChild;
                
                // Buscar producto en inventario por nombre
                const inventoryProduct = inventoryData.find(p => p.name === product.name);
                if (inventoryProduct) {
                    const productSelect = lastRow.querySelector('.product-select');
                    productSelect.value = inventoryProduct.id;
                    
                    // Actualizar precio automáticamente
                    updateProductPrice(productSelect);
                }
                
                // Establecer cantidad (el precio ya se actualizó automáticamente)
                lastRow.querySelector('.quantity-input').value = product.quantity;
                
                // Recalcular subtotal
                calculateRowSubtotal(lastRow.querySelector('.quantity-input'));
            });

            calculateTotals();
            document.getElementById('saleModal').style.display = 'block';
        }

        // Función para ver detalles de venta
        function viewSale(id) {
            const sale = salesData.find(s => s.id === id);
            if (!sale) return;

            alert(`Detalles de la Venta ${sale.invoice}\n\n` +
                  `Cliente: ${sale.customerName}\n` +
                  `Fecha: ${new Date(sale.date).toLocaleDateString('es-ES')}\n` +
                  `Estado: ${sale.status}\n\n` +
                  `Productos:\n${sale.products.map(p => `- ${p.quantity}x ${p.name} ($${p.price.toFixed(2)})`).join('\n')}\n\n` +
                  `Subtotal: $${sale.subtotal.toFixed(2)}\n` +
                  `IVA: $${sale.tax.toFixed(2)}\n` +
                  `Total: $${sale.total.toFixed(2)}\n\n` +
                  `Notas: ${sale.notes || 'Sin notas'}`);
        }

        // Función para eliminar venta
        function deleteSale(id) {
            if (confirm('¿Estás seguro de que deseas eliminar esta venta?')) {
                const saleToDelete = salesData.find(s => s.id === id);
                
                // Restaurar stock al inventario si la venta estaba completada
                if (saleToDelete && saleToDelete.status === 'completed') {
                    restoreInventoryStock(saleToDelete.products);
                    console.log('Stock restaurado al eliminar venta completada');
                }
                
                salesData = salesData.filter(s => s.id !== id);
                saveDataToLocalStorage();
                renderTable();
                updateStats();
                alert('Venta eliminada exitosamente y stock restaurado automáticamente.');
            }
        }

        // Función para cerrar modal
        function closeModal() {
            document.getElementById('saleModal').style.display = 'none';
            document.getElementById('saleForm').reset();
            currentEditId = null;
        }

        // Función para exportar datos a Excel
        function exportSales() {
            const data = salesData.map(sale => ({
                'Factura': sale.invoice,
                'Cliente': sale.customerName,
                'Fecha': new Date(sale.date).toLocaleDateString('es-ES'),
                'Productos': sale.products.map(p => `${p.quantity}x ${p.name}`).join(', '),
                'Subtotal': sale.subtotal,
                'IVA': sale.tax,
                'Total': sale.total,
                'Estado': sale.status === 'pending' ? 'Pendiente' : 
                         sale.status === 'processing' ? 'En Proceso' : 
                         sale.status === 'completed' ? 'Completada' : 'Cancelada',
                'Notas': sale.notes || ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Ventas');
            
            // Ajustar ancho de columnas
            const colWidths = [
                { wch: 12 }, // Factura
                { wch: 25 }, // Cliente
                { wch: 12 }, // Fecha
                { wch: 40 }, // Productos
                { wch: 12 }, // Subtotal
                { wch: 10 }, // IVA
                { wch: 12 }, // Total
                { wch: 12 }, // Estado
                { wch: 30 }  // Notas
            ];
            worksheet['!cols'] = colWidths;

            const fileName = `ventas_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        // Event Listeners
        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Recopilar productos y validar stock
            const productRows = document.querySelectorAll('.product-row');
            const products = [];
            let stockError = false;
            
            productRows.forEach(row => {
                const select = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity-input');
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const maxQuantity = parseInt(quantityInput.getAttribute('max')) || 0;
                
                if (select.value && quantity > 0 && price > 0) {
                    // Validar stock disponible
                    if (maxQuantity > 0 && quantity > maxQuantity) {
                        quantityInput.style.border = '2px solid #e53e3e';
                        quantityInput.style.background = '#fed7d7';
                        stockError = true;
                        alert(`Error: La cantidad solicitada para "${select.selectedOptions[0].textContent.split(' - ')[1]}" (${quantity}) excede el stock disponible (${maxQuantity})`);
                        return;
                    }
                    
                    const productName = select.selectedOptions[0].textContent.split(' - ')[1].split(' | ')[0];
                    products.push({
                        id: select.value,
                        name: productName,
                        quantity: quantity,
                        price: price,
                        subtotal: quantity * price
                    });
                }
            });

            if (stockError) {
                return;
            }

            if (products.length === 0) {
                alert('Debe agregar al menos un producto a la venta.');
                return;
            }

            // Calcular totales: los precios ya incluyen IVA
            const totalWithIVA = products.reduce((sum, product) => sum + product.subtotal, 0);
            const subtotalWithoutIVA = totalWithIVA / 1.13; // Extraer IVA del total
            const ivaAmount = totalWithIVA - subtotalWithoutIVA;

            const selectedCustomer = customersData.find(c => c.id == document.getElementById('saleCustomer').value);
            
            const formData = {
                invoice: document.getElementById('saleInvoice').value,
                customerId: parseInt(document.getElementById('saleCustomer').value),
                customerName: selectedCustomer ? selectedCustomer.name : '',
                date: document.getElementById('saleDate').value,
                products: products,
                subtotal: subtotalWithoutIVA,
                tax: ivaAmount,
                total: totalWithIVA,
                status: document.getElementById('saleStatus').value,
                notes: document.getElementById('saleNotes').value
            };

            if (currentEditId) {
                // Editar venta existente
                const index = salesData.findIndex(s => s.id === currentEditId);
                const oldSale = salesData[index];
                
                // Restaurar stock de la venta anterior (si estaba completada)
                if (oldSale.status === 'completed') {
                    restoreInventoryStock(oldSale.products);
                }
                
                salesData[index] = { ...salesData[index], ...formData };
                
                // Descontar stock de la venta actualizada (si está completada)
                if (formData.status === 'completed') {
                    const stockUpdateResult = updateInventoryStock(formData.products);
                    console.log('Resultado actualización stock venta editada:', stockUpdateResult);
                }
            } else {
                // Agregar nueva venta
                const newId = Math.max(...salesData.map(s => s.id), 0) + 1;
                salesData.push({ id: newId, ...formData });
                invoiceCounter++; // Incrementar contador para próxima factura
                
                // Descontar stock del inventario solo si la venta está completada
                if (formData.status === 'completed') {
                    const stockUpdateResult = updateInventoryStock(formData.products);
                    console.log('Resultado actualización stock nueva venta:', stockUpdateResult);
                }
            }

            saveDataToLocalStorage();
            renderTable();
            updateStats();
            closeModal();
            
            const action = currentEditId ? 'actualizada' : 'agregada';
            let message = `Venta ${action} exitosamente y guardada automáticamente.`;
            
            if (formData.status === 'completed') {
                message += '\n\n✅ Stock del inventario actualizado automáticamente.';
                message += '\nRevisa la consola (F12) para ver los detalles de la actualización.';
            } else {
                message += '\n\nℹ️ El stock se descontará cuando la venta esté "Completada".';
            }
            
            alert(message);
        });

        document.getElementById('searchInput').addEventListener('input', filterTable);
        document.getElementById('statusFilter').addEventListener('change', filterTable);
        document.getElementById('dateFromFilter').addEventListener('change', filterTable);
        document.getElementById('dateToFilter').addEventListener('change', filterTable);
        document.getElementById('sortFilter').addEventListener('change', sortTable);

        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('saleModal')) {
                closeModal();
            }
        });

        // Inicializar página
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== INICIALIZANDO MÓDULO DE VENTAS ===');
            
            // Configurar listener de Firebase para sincronización en tiempo real
            if (window.firebaseUtils && window.firebaseUtils.isEnabled()) {
                window.firebaseUtils.setupListener('salesData', (data) => {
                    console.log('🔄 Datos de ventas actualizados desde Firebase');
                    renderTable();
                    updateStats();
                });
            }
            
            // Cargar datos desde Firebase/localStorage
            await loadDataFromLocalStorage();
            
            // Cargar datos frescos de inventario y clientes
            customersData = loadCustomersFromLocalStorage();
            inventoryData = loadProductsFromLocalStorage();
            
            console.log('Ventas cargadas:', salesData.length);
            console.log('Clientes cargados:', customersData.length);
            console.log('Productos en inventario cargados:', inventoryData.length);
            
            if (inventoryData.length > 0) {
                console.log('Primer producto del inventario:', inventoryData[0]);
            } else {
                console.warn('¡ADVERTENCIA! No hay productos en el inventario');
            }
            
            renderTable();
            updateStats();
        });
    </script>
</body>
</html>
